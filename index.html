<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Flappy â€” Bigger Bird & BGM</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  background: linear-gradient(#70c5ce, #4ec0ca);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: Arial;
  touch-action: none;
  -webkit-tap-highlight-color: transparent;
}
#wrap {
  position: relative;
  width: 100%;
  height: 100%;
}
canvas {
  display: block;
  border-radius: 0;
  box-shadow: none;
  width: 100%;
  height: 100%;
}
#msg {
  position: absolute;
  width: 100%;
  text-align: center;
  top: 50%;
  transform: translateY(-50%);
  color: #fff;
  font-size: 22px;
  text-shadow: 0 2px 6px rgba(0,0,0,.5);
  pointer-events: none;
  z-index: 500;
}
#startBtn {
  position: absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:16px 28px;
  font-size:24px;
  border:none;
  border-radius:10px;
  background:#ffdd57;
  color:#222;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:1000;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}
/* Mobile responsive adjustments */
@media (max-width: 768px) {
  #msg {
    font-size: 18px;
    padding: 0 20px;
  }
  #startBtn {
    padding: 12px 24px;
    font-size: 20px;
  }
}
@media (max-width: 480px) {
  #msg {
    font-size: 16px;
  }
  #startBtn {
    padding: 10px 20px;
    font-size: 18px;
  }
}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
  <div id="msg"></div>
  <button id="startBtn">Start Game</button>
</div>

<script>
(() => {
  // -------- Audio Setup --------
  let audioCtx = null;
  let bgm = null;
  let audioInitialized = false;

  function ensureAudioContext(){
    if(!audioCtx){
      const C = window.AudioContext || window.webkitAudioContext;
      if(C){ audioCtx = new C(); }
    }
  }

  function initializeBGM(){
    if(!bgm){
      bgm = new Audio('bgm.mp3');
      bgm.loop = true;
      bgm.volume = 0.35;
      bgm.playsInline = true;
      bgm.preload = 'auto';
    }
  }

  let jumpBuffer=null, gameoverBuffer=null;

  async function loadAudioBuffer(url){
    try{
      const res = await fetch(url, {cache:'no-store'});
      const arrayBuffer = await res.arrayBuffer();
      ensureAudioContext();
      if(!audioCtx) return null;
      return await audioCtx.decodeAudioData(arrayBuffer);
    }catch{ return null; }
  }

  loadAudioBuffer('jump.mp3').then(b=>jumpBuffer=b);
  loadAudioBuffer('gameover.mp3').then(b=>gameoverBuffer=b);

  function playBuffer(buffer, volume=1){
    if(!audioCtx || !buffer) return false;
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const gain = audioCtx.createGain();
    gain.gain.value = volume;
    src.connect(gain).connect(audioCtx.destination);
    src.start(0);
    return true;
  }

  function playJump(){ ensureAudioContext(); if(jumpBuffer) playBuffer(jumpBuffer,0.95); else new Audio('jump.mp3').play().catch(()=>{}); }
  function playGameOver(){ ensureAudioContext(); if(gameoverBuffer) playBuffer(gameoverBuffer,1); else new Audio('gameover.mp3').play().catch(()=>{}); }

  async function startBgm(){
    if(!bgm) initializeBGM();
    try{
      bgm.currentTime = 0;
      await bgm.play();
      audioInitialized = true;
    }catch(err){
      console.log('BGM play failed:', err);
      // Retry once if AudioContext was suspended
      if(audioCtx && audioCtx.state === 'suspended'){
        await audioCtx.resume();
      }
      try{
        await bgm.play();
        audioInitialized = true;
      }catch(e){
        console.log('BGM retry failed:', e);
      }
    }
  }
  function stopBgm(){ if(bgm) bgm.pause(); }

  // -------- Game Setup --------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const msgEl = document.getElementById('msg');
  const startBtn = document.getElementById('startBtn');

  const imgWidth=810, imgHeight=1080;
  const imgBBox={left:76,right:88,top:422,bottom:39};

  const userImg = new Image();
  userImg.src='char.png';
  let userImgLoaded=false;
  userImg.onload=()=>{userImgLoaded=true;};

  const fallback=document.createElement('canvas');
  fallback.width=64; fallback.height=64;
  const fctx=fallback.getContext('2d');
  fctx.fillStyle='#FFDD57'; fctx.fillRect(0,0,64,64);
  fctx.fillStyle='#222'; fctx.fillRect(40,10,10,10);

  const bird={x:80,y:100,w:50,h:70,vy:0,gravity:0.45,jump:-8};
  const pipeWidth=70;
  let pipes=[], spawnTimer=0, score=0;
  let running=false, gameOver=false;

  function computeHitbox(){
    const scaleX = bird.w / imgWidth;
    const scaleY = bird.h / imgHeight;
    return { x: bird.x + imgBBox.left*scaleX, y: bird.y + imgBBox.top*scaleY, w: bird.w-(imgBBox.left+imgBBox.right)*scaleX, h: bird.h-(imgBBox.top+imgBBox.bottom)*scaleY };
  }

  function flap(){
    if(gameOver){ return; }
    ensureAudioContext();
    if(!running){
      running=true; msgEl.style.display='none'; startBtn.style.display='none';
    }
    playJump();
    bird.vy = bird.jump;
  }

  function spawnPipe(){
    // Adaptive gap based on bird size for consistent difficulty
    const gap = Math.max(bird.h * 2.8, 180);
    const minTop=30, maxTop=canvas.height-gap-50;
    const top=Math.floor(Math.random()*(maxTop-minTop+1))+minTop;
    pipes.push({x:canvas.width+20, top, bottom:top+gap, passed:false});
  }

  function update(){
    if(!running || gameOver) return;
    bird.vy += bird.gravity;
    bird.y += bird.vy;
    spawnTimer++;
    if(spawnTimer>90){ spawnPipe(); spawnTimer=0; }
    for(let i=pipes.length-1;i>=0;i--){
      const p=pipes[i];
      p.x-=3;
      if(!p.passed && p.x+pipeWidth<bird.x){ p.passed=true; score++; }
      if(p.x<-pipeWidth) pipes.splice(i,1);
    }
    if(bird.y<-50 || bird.y+bird.h>canvas.height+50){ endGame(); return; }
    const hb=computeHitbox();
    for(const p of pipes){
      if(hb.x<p.x+pipeWidth && hb.x+hb.w>p.x && (hb.y<p.top || hb.y+hb.h>p.bottom)){
        endGame(); return;
      }
    }
  }

  function draw(){
    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,'#70c5ce'); g.addColorStop(1,'#4ec0ca');
    ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw pipes
    ctx.fillStyle='#2e8b34';
    for(const p of pipes){
      ctx.fillRect(p.x,0,pipeWidth,p.top);
      ctx.fillRect(p.x,p.bottom,pipeWidth,canvas.height-p.bottom);
      ctx.fillStyle='#1f6f28';
      ctx.fillRect(p.x-4,p.top-8,pipeWidth+8,8);
      ctx.fillRect(p.x-4,p.bottom,pipeWidth+8,8);
      ctx.fillStyle='#2e8b34';
    }

    // draw bird
    if(userImgLoaded) ctx.drawImage(userImg,bird.x,bird.y,bird.w,bird.h);
    else ctx.drawImage(fallback,bird.x,bird.y,bird.w,bird.h);

    // draw score on top-left corner
    ctx.fillStyle='white';
    const fontSize = Math.max(20, Math.floor(canvas.height * 0.04));
    ctx.font=`${fontSize}px Arial`;
    ctx.fillText('Score: '+score, 15, fontSize + 10);
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }

  function endGame(){
    gameOver=true; running=false;
    stopBgm();
    playGameOver();
    msgEl.style.display='block';
    msgEl.innerHTML=`GAME OVER<br>Score: ${score}`;
    startBtn.style.display='block';
    startBtn.innerText='Restart Game';
  }

  startBtn.addEventListener('click', async () => {
    ensureAudioContext();
    initializeBGM();
    
    // Start BGM first, before changing game state
    await startBgm();
    
    // Then update game state
    running=true; gameOver=false;
    msgEl.style.display='none'; startBtn.style.display='none';
    bird.y = canvas.height/2 - bird.h/2;
    bird.vy = 0;
    pipes=[]; spawnTimer=0; score=0;
  });

  // Flap input - prevent clicking on start button from also triggering flap
  window.addEventListener('pointerdown', (e) => {
    if(e.target !== startBtn) flap();
  });
  window.addEventListener('keydown', e => { if(e.code==='Space'||e.key===' '){ e.preventDefault(); flap(); } });
  
  // Touch handling for mobile
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if(running && !gameOver) flap();
  }, { passive: false });

  // Responsive canvas
  function resizeCanvas(){
    // Always use full viewport
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // Detect if mobile or desktop based on screen width and touch capability
    const isMobile = window.innerWidth < 768 || ('ontouchstart' in window);
    const baseSize = Math.min(canvas.width, canvas.height);
    
    if(isMobile){
      // Mobile: larger bird for touch gameplay
      bird.w = baseSize * 0.25;  // 25% of smaller dimension
      bird.h = bird.w * 1.4;
    } else {
      // Desktop: appropriately sized for mouse/keyboard
      bird.w = baseSize * 0.20;  // 20% of smaller dimension
      bird.h = bird.w * 1.4;
    }
    
    bird.x = canvas.width * 0.15;
    
    // Reposition bird if game is not running
    if(!running){
      bird.y = canvas.height/2 - bird.h/2;
    }
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', () => {
    setTimeout(resizeCanvas, 100);
  });
  resizeCanvas();

  bird.y = canvas.height/2 - bird.h/2;
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
